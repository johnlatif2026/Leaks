<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial;padding:20px;max-width:900px;margin:auto;}
    .box{border:1px solid #ddd;padding:12px;border-radius:6px;margin-bottom:12px;}
  </style>
</head>
<body>
  <h1>لوحة التحكم</h1>
  <button id="logout">تسجيل خروج</button>

  <div class="box">
    <h3>الزيارات الحية</h3>
    <ul id="liveList"></ul>
  </div>

  <div class="box">
    <h3>انشاء قسم</h3>
    <input id="sectionName" placeholder="اسم القسم" />
    <button id="createSection">انشاء</button>
    <div id="sectionsList"></div>
  </div>

  <div class="box">
    <h3>نشر منشور على الصفحة الرئيسية</h3>
    <input id="postTitle" placeholder="العنوان" /><br/>
    <select id="postSection"></select><br/>
    <input id="postImage" placeholder="رابط الصورة (اختياري)" /><br/>
    <textarea id="postText" placeholder="النص"></textarea><br/>
    <button id="publish">ارسال</button>
  </div>

  <script>
    // SSE
    const evtSource = new EventSource('/api/events');
    evtSource.addEventListener('new-entry', e => {
      const data = JSON.parse(e.data);
      const li = document.createElement('li');
      li.textContent = `دخل: ${data.name || '(no name)'} @ ${new Date().toLocaleTimeString()}`;
      document.getElementById('liveList').prepend(li);
    });
    evtSource.addEventListener('new-post', e => {
      const data = JSON.parse(e.data);
      const li = document.createElement('li');
      li.textContent = `منشور جديد: ${data.title || '(بدون عنوان)'} قسم: ${data.section || ''}`;
      document.getElementById('liveList').prepend(li);
    });

    // logout
    document.getElementById('logout').addEventListener('click', async ()=>{
      await fetch('/api/logout', { method: 'POST' });
      window.location.href = '/login.html';
    });

    // Sections
    async function loadSections(){
      const res = await fetch('/api/sections');
      const j = await res.json();
      const sel = document.getElementById('postSection');
      sel.innerHTML = '<option value="">-- اختر قسم --</option>';
      const list = document.getElementById('sectionsList');
      list.innerHTML = '';
      j.sections.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.name; opt.textContent = s.name;
        sel.appendChild(opt);
        const div = document.createElement('div'); div.textContent = s.name; list.appendChild(div);
      });
    }
    loadSections();

    document.getElementById('createSection').addEventListener('click', async ()=>{
      const name = document.getElementById('sectionName').value.trim();
      if (!name) return alert('اكتب اسم القسم');
      const res = await fetch('/api/sections', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name })
      });
      if (res.ok) { alert('تم الإنشاء'); document.getElementById('sectionName').value=''; loadSections(); }
      else alert('فشل الإنشاء');
    });

    // Publish post
    document.getElementById('publish').addEventListener('click', async ()=>{
      const title = document.getElementById('postTitle').value;
      const section = document.getElementById('postSection').value;
      const imageUrl = document.getElementById('postImage').value;
      const text = document.getElementById('postText').value;
      const res = await fetch('/api/publish', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ title, section, imageUrl, text })
      });
      if (res.ok) { alert('تم النشر'); document.getElementById('postTitle').value=''; document.getElementById('postText').value=''; loadPostsPreview(); }
      else alert('فشل النشر');
    });

    async function loadPostsPreview(){
      const res = await fetch('/api/posts');
      const j = await res.json();
      console.log('latest posts', j.posts);
    }
  </script>
</body>
</html>
